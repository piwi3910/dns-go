# Nginx configuration for DNS load balancing
# Routes DNS traffic to worker containers

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

# DNS UDP load balancing
stream {
    # Upstream DNS workers for UDP
    upstream dns_udp {
        least_conn;
        server dns-worker:53;
        # Additional workers added automatically by Docker scaling
    }

    # Upstream DNS workers for TCP
    upstream dns_tcp {
        least_conn;
        server dns-worker:53;
    }

    # UDP DNS listener
    server {
        listen 53 udp;
        proxy_pass dns_udp;
        proxy_timeout 5s;
        proxy_responses 1;
    }

    # TCP DNS listener
    server {
        listen 53;
        proxy_pass dns_tcp;
        proxy_timeout 10s;
    }
}
