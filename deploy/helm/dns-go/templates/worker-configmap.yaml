{{- if .Values.worker.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dns-go.fullname" . }}-worker
  labels:
    {{- include "dns-go.worker.labels" . | nindent 4 }}
data:
  config.yaml: |
    mode: worker
    worker:
      listen_address: "{{ .Values.worker.config.listenAddress }}"
      heartbeat_interval: {{ .Values.worker.config.heartbeatInterval }}
      reconnect_delay: {{ .Values.worker.config.reconnectDelay }}
    cache:
      mode: {{ .Values.cache.mode }}
      message_cache:
        max_size_mb: {{ .Values.cache.messageCache.maxSizeMB }}
        num_shards: {{ .Values.cache.messageCache.numShards }}
        min_ttl: {{ .Values.cache.messageCache.minTTL }}
        max_ttl: {{ .Values.cache.messageCache.maxTTL }}
      rrset_cache:
        max_size_mb: {{ .Values.cache.rrsetCache.maxSizeMB }}
        num_shards: {{ .Values.cache.rrsetCache.numShards }}
      {{- if .Values.cache.sharedCache.enabled }}
      shared_cache:
        enabled: true
        type: {{ .Values.cache.sharedCache.type }}
        {{- if eq .Values.cache.sharedCache.type "redis" }}
        redis:
          address: "{{ .Values.cache.sharedCache.redis.address }}"
          database: {{ .Values.cache.sharedCache.redis.database }}
          {{- if .Values.cache.sharedCache.redis.authSecret }}
          password_file: /etc/dns-go/secrets/redis-password
          {{- end }}
        {{- else if eq .Values.cache.sharedCache.type "redis-sentinel" }}
        sentinel:
          master_name: "{{ .Values.cache.sharedCache.redisSentinel.masterName }}"
          addresses:
            {{- toYaml .Values.cache.sharedCache.redisSentinel.addresses | nindent 12 }}
          read_preference: {{ .Values.cache.sharedCache.redisSentinel.readPreference }}
          {{- if .Values.cache.sharedCache.redisSentinel.authSecret }}
          password_file: /etc/dns-go/secrets/redis-password
          {{- end }}
        {{- else if eq .Values.cache.sharedCache.type "redis-cluster" }}
        cluster:
          addresses:
            {{- toYaml .Values.cache.sharedCache.redisCluster.addresses | nindent 12 }}
          read_preference: {{ .Values.cache.sharedCache.redisCluster.readPreference }}
          {{- if .Values.cache.sharedCache.redisCluster.authSecret }}
          password_file: /etc/dns-go/secrets/redis-password
          {{- end }}
        {{- end }}
        key_prefix: "{{ .Values.cache.sharedCache.keyPrefix }}"
        ttl_multiplier: {{ .Values.cache.sharedCache.ttlMultiplier }}
        pool_size: {{ .Values.cache.sharedCache.poolSize }}
        min_idle_conns: {{ .Values.cache.sharedCache.minIdleConns }}
        max_retries: {{ .Values.cache.sharedCache.maxRetries }}
      {{- end }}
      prefetch:
        enabled: {{ .Values.cache.prefetch.enabled }}
        threshold_hits: {{ .Values.cache.prefetch.thresholdHits }}
        threshold_ttl_percent: {{ .Values.cache.prefetch.thresholdTTLPercent }}
      invalidation:
        strategy: {{ .Values.cache.invalidation.strategy }}
        {{- if eq .Values.cache.invalidation.strategy "pubsub" }}
        pubsub_channel: "{{ .Values.cache.invalidation.pubsubChannel }}"
        {{- end }}
{{- end }}
